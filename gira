#!/usr/bin/env bash
# GiraHelper v1
# Copyright (C) 2013 Jonas Friedmann

# Variables
notifierBin="/Applications/terminal-notifier.app/Contents/MacOS/terminal-notifier"
notifierBool=false

# Get passed arguments
state="${1}"
outlet="${2}"

# Check for state
if [[ ${state} != "on" &&  ${state} != "off" &&  ${state} != "config" ]]; then
  echo "Invalid argument: has to be 'on', 'off' or 'config'."
  exit 1
fi

# Check for config file
if [[ ! -f ~/.gira.conf ]]; then
  echo "Missing configuration file: ~/.gira.conf"
  exit 1
fi

# Check for terminal-notifier
if [[ -f "${notifierBin}" ]]; then
  notifierBool=true
fi

# Load config file
. ~/.gira.conf

# Function to send Notification Center messages
function notification {
    # Speed up execution by executing next command in the background
    notifierBool && /Applications/terminal-notifier.app/Contents/MacOS/terminal-notifier -title "Gira" -message "${@}" &
}

# Translate state
if [[ "$state" == "on" ]]; then
  state="ein"
elif [[ "$state" == "off" ]]; then
  state="aus"
elif [[ "$state" == "config" ]]; then
  echo "Server: ${SERVER}"
  echo "Office: ${OFFICE}"
  echo "Outlets:"
  for i in "${OUTLETS[@]}"; do
    echo "- ${OFFICE}:0${i}"
  done
  exit 0
fi

# Check if outlet sub arg
if [[ ! -z "${outlet}" ]]; then
  printf "Trigger outlet '%s:0%s (%s)'... " "${OFFICE}" "${outlet}" "${state}"
  curl -s "${SERVER}/${OFFICE}licht0${outlet}${state}"
  notification "Trigger outlet '${OFFICE}:0${outlet} (${state})' ..." >/dev/null 2>&1
  printf "done\n"
  exit 0
fi

# For each outlet defined in config
for i in "${OUTLETS[@]}"; do
  printf "Trigger outlet '%s:0%s (%s)'... " "${OFFICE}" "${i}" "${state}"
  curl -s "${SERVER}/${OFFICE}licht0${i}${state}"
  notification "Trigger outlet '${OFFICE}:0${i} (${state})' ..." >/dev/null 2>&1
  printf "done\n"
done

exit 0
